<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analytics</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        body {
            background: var(--color-bg);
            padding: 0;
        }

        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-secondary);
            text-decoration: none;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 8px;
            transition: var(--transition);
            margin-bottom: 24px;
        }

        .back-btn:hover {
            color: var(--color-accent);
            background: var(--color-card-bg);
            transform: translateX(-4px);
        }

        .header {
            text-align: center;
            padding: 40px 0 60px;
        }

        .header h1 {
            font-size: clamp(36px, 5vw, 48px);
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--color-text);
        }

        .header p {
            font-size: 18px;
            color: var(--color-text-secondary);
            font-weight: 400;
        }

        .overall-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .stat-card {
            background: var(--color-card-bg);
            padding: 32px;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card.primary {
            background: linear-gradient(135deg, var(--color-accent) 0%, #1e4eef 100%);
            color: white;
            border: none;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #2ed573 0%, #26de81 100%);
            color: white;
            border: none;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ffa502 0%, #ff6348 100%);
            color: white;
            border: none;
        }

        .stat-number {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }

        .stat-subtitle {
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.8;
        }

        .grade-projection {
            background: var(--color-card-bg);
            padding: 32px;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            margin-bottom: 48px;
        }

        .grade-projection h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--color-text);
        }

        .grade-bars {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .grade-bar {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .grade-label {
            font-weight: 700;
            font-size: 18px;
            min-width: 50px;
            color: var(--color-text);
        }

        .grade-progress {
            flex: 1;
            height: 32px;
            background: var(--color-border);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }

        .grade-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-accent) 0%, #1e4eef 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            transition: width 1s ease;
        }

        .grade-fill.achieved {
            background: linear-gradient(90deg, #2ed573 0%, #26de81 100%);
        }

        .grade-fill.close {
            background: linear-gradient(90deg, #ffa502 0%, #ff7f50 100%);
        }

        .grade-target {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 600;
            min-width: 100px;
            text-align: right;
        }

        .papers-summary {
            margin-bottom: 48px;
        }

        .papers-summary h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--color-text);
        }

        .papers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
        }

        .paper-summary-card {
            background: var(--color-card-bg);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--color-border);
            transition: var(--transition);
        }

        .paper-summary-card:hover {
            border-color: var(--color-accent);
            box-shadow: var(--shadow-md);
        }

        .paper-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .paper-code {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
        }

        .paper-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .score-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-accent);
        }

        .score-percentage {
            font-size: 32px;
            font-weight: 700;
        }

        .score-percentage.excellent {
            color: #2ed573;
        }

        .score-percentage.good {
            color: #26de81;
        }

        .score-percentage.okay {
            color: #ffa502;
        }

        .score-percentage.poor {
            color: #ff6348;
        }

        .topic-breakdown {
            margin-bottom: 48px;
        }

        .topic-breakdown h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--color-text);
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .topic-card {
            background: var(--color-card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }

        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .topic-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--color-text);
        }

        .topic-score {
            font-weight: 700;
            font-size: 18px;
        }

        .topic-bar {
            height: 8px;
            background: var(--color-border);
            border-radius: 4px;
            overflow: hidden;
        }

        .topic-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .weak-areas {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
            color: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 48px;
        }

        .weak-areas h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .weak-areas-list {
            display: grid;
            gap: 12px;
        }

        .weak-area-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weak-area-name {
            font-weight: 600;
            font-size: 16px;
        }

        .weak-area-score {
            font-weight: 700;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: var(--color-text-secondary);
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 16px;
        }

        .empty-state a {
            display: inline-block;
            margin-top: 24px;
            padding: 14px 32px;
            background: var(--color-accent);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            transition: var(--transition);
        }

        .empty-state a:hover {
            background: var(--color-accent-hover);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .papers-grid,
            .topics-grid {
                grid-template-columns: 1fr;
            }

            .grade-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .grade-target {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <a href="chemistry-tracker.html" class="back-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to Papers
        </a>

        <div class="header">
            <h1>Performance Analytics</h1>
            <p>Track your progress and identify weak areas</p>
        </div>

        <div id="contentContainer">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <script>
        // Grade boundaries for A-Level Chemistry (Total 300 marks across 3 papers)
        const GRADE_BOUNDARIES = {
            'A*': 239,
            'A': 198,
            'B': 162,
            'C': 126,
            'D': 90,
            'E': 55
        };

        let analytics = {};

        // Initialize
        function init() {
            loadAnalytics();
            render();
        }

        // Load analytics from localStorage
        function loadAnalytics() {
            const saved = localStorage.getItem('chemistry-analytics');
            if (saved) {
                analytics = JSON.parse(saved);
            }
        }

        // Calculate overall stats
        function calculateOverallStats() {
            const papers = Object.values(analytics);

            if (papers.length === 0) {
                return null;
            }

            const totalMaxMarks = papers.reduce((sum, p) => sum + p.totalMarks, 0);
            const totalEarnedMarks = papers.reduce((sum, p) => sum + p.earnedMarks, 0);
            const averagePercentage = totalMaxMarks > 0 ? (totalEarnedMarks / totalMaxMarks * 100) : 0;

            // Project to 300 marks
            const projectedTotal = (totalEarnedMarks / totalMaxMarks) * 300;

            return {
                papersCompleted: papers.length,
                totalMaxMarks,
                totalEarnedMarks,
                averagePercentage,
                projectedTotal
            };
        }

        // Calculate topic performance
        function calculateTopicPerformance() {
            const topicStats = {};

            Object.values(analytics).forEach(paper => {
                paper.questions.forEach(q => {
                    if (!topicStats[q.topic]) {
                        topicStats[q.topic] = {
                            maxMarks: 0,
                            earnedMarks: 0,
                            count: 0
                        };
                    }

                    topicStats[q.topic].maxMarks += parseFloat(q.maxMarks) || 0;
                    topicStats[q.topic].earnedMarks += parseFloat(q.earnedMarks) || 0;
                    topicStats[q.topic].count += 1;
                });
            });

            // Convert to array and calculate percentages
            return Object.entries(topicStats)
                .map(([topic, stats]) => ({
                    topic,
                    maxMarks: stats.maxMarks,
                    earnedMarks: stats.earnedMarks,
                    percentage: stats.maxMarks > 0 ? (stats.earnedMarks / stats.maxMarks * 100) : 0,
                    count: stats.count
                }))
                .sort((a, b) => a.percentage - b.percentage);
        }

        // Get score class
        function getScoreClass(percentage) {
            if (percentage >= 80) return 'excellent';
            if (percentage >= 70) return 'good';
            if (percentage >= 50) return 'okay';
            return 'poor';
        }

        // Get bar color
        function getBarColor(percentage) {
            if (percentage >= 80) return '#2ed573';
            if (percentage >= 70) return '#26de81';
            if (percentage >= 50) return '#ffa502';
            return '#ff6348';
        }

        // Render everything
        function render() {
            const container = document.getElementById('contentContainer');
            const stats = calculateOverallStats();

            if (!stats || stats.papersCompleted === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Data Yet</h3>
                        <p>Start tracking your paper progress to see analytics here!</p>
                        <a href="chemistry-tracker.html">Go to Past Papers</a>
                    </div>
                `;
                return;
            }

            const topicPerformance = calculateTopicPerformance();
            const weakAreas = topicPerformance.slice(0, 5);

            // Determine projected grade
            let projectedGrade = 'U';
            let projectedGradeClass = '';
            if (stats.projectedTotal >= GRADE_BOUNDARIES['A*']) {
                projectedGrade = 'A*';
                projectedGradeClass = 'success';
            } else if (stats.projectedTotal >= GRADE_BOUNDARIES['A']) {
                projectedGrade = 'A';
                projectedGradeClass = 'success';
            } else if (stats.projectedTotal >= GRADE_BOUNDARIES['B']) {
                projectedGrade = 'B';
                projectedGradeClass = 'success';
            } else if (stats.projectedTotal >= GRADE_BOUNDARIES['C']) {
                projectedGrade = 'C';
                projectedGradeClass = 'warning';
            } else if (stats.projectedTotal >= GRADE_BOUNDARIES['D']) {
                projectedGrade = 'D';
                projectedGradeClass = 'warning';
            } else if (stats.projectedTotal >= GRADE_BOUNDARIES['E']) {
                projectedGrade = 'E';
                projectedGradeClass = 'warning';
            }

            container.innerHTML = `
                <div class="overall-stats">
                    <div class="stat-card primary">
                        <div class="stat-number">${stats.papersCompleted}</div>
                        <div class="stat-label">Papers Tracked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalEarnedMarks.toFixed(0)} / ${stats.totalMaxMarks}</div>
                        <div class="stat-label">Total Marks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.averagePercentage.toFixed(1)}%</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card ${projectedGradeClass}">
                        <div class="stat-number">${projectedGrade}</div>
                        <div class="stat-label">Projected Grade</div>
                        <div class="stat-subtitle">${stats.projectedTotal.toFixed(0)} / 300 marks</div>
                    </div>
                </div>

                <div class="grade-projection">
                    <h2>Grade Boundaries Progress</h2>
                    <div class="grade-bars">
                        ${Object.entries(GRADE_BOUNDARIES).map(([grade, boundary]) => {
                            const percentage = (stats.projectedTotal / boundary) * 100;
                            const cappedPercentage = Math.min(percentage, 100);
                            const achieved = percentage >= 100;
                            const close = percentage >= 90 && percentage < 100;
                            const fillClass = achieved ? 'achieved' : (close ? 'close' : '');

                            return `
                                <div class="grade-bar">
                                    <div class="grade-label">${grade}</div>
                                    <div class="grade-progress">
                                        <div class="grade-fill ${fillClass}" style="width: ${cappedPercentage}%">
                                            ${cappedPercentage >= 20 ? cappedPercentage.toFixed(0) + '%' : ''}
                                        </div>
                                    </div>
                                    <div class="grade-target">${boundary} marks</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="papers-summary">
                    <h2>Papers Overview</h2>
                    <div class="papers-grid">
                        ${Object.values(analytics).map(paper => {
                            const scoreClass = getScoreClass(parseFloat(paper.percentage));
                            return `
                                <div class="paper-summary-card">
                                    <div class="paper-title">${paper.paper.title}</div>
                                    <div class="paper-code">${paper.paper.paperCode} - ${paper.paper.session} ${paper.paper.year}</div>
                                    <div class="paper-score">
                                        <div class="score-value">${paper.earnedMarks.toFixed(1)} / ${paper.totalMarks}</div>
                                        <div class="score-percentage ${scoreClass}">${paper.percentage}%</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                ${topicPerformance.length > 0 ? `
                    <div class="topic-breakdown">
                        <h2>Topic Performance</h2>
                        <div class="topics-grid">
                            ${topicPerformance.map(topic => {
                                const color = getBarColor(topic.percentage);
                                return `
                                    <div class="topic-card">
                                        <div class="topic-header">
                                            <div class="topic-name">${topic.topic}</div>
                                            <div class="topic-score" style="color: ${color}">
                                                ${topic.percentage.toFixed(0)}%
                                            </div>
                                        </div>
                                        <div class="topic-bar">
                                            <div class="topic-bar-fill" style="width: ${topic.percentage}%; background: ${color}"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    ${weakAreas.length > 0 ? `
                        <div class="weak-areas">
                            <h2>⚠️ Areas Needing Focus</h2>
                            <p style="margin-bottom: 24px; opacity: 0.9;">
                                These topics have the lowest performance. Focus your revision here for maximum impact!
                            </p>
                            <div class="weak-areas-list">
                                ${weakAreas.map(area => `
                                    <div class="weak-area-item">
                                        <div>
                                            <div class="weak-area-name">${area.topic}</div>
                                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                                                ${area.earnedMarks.toFixed(1)} / ${area.maxMarks.toFixed(1)} marks (${area.count} questions)
                                            </div>
                                        </div>
                                        <div class="weak-area-score">${area.percentage.toFixed(0)}%</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                ` : ''}
            `;
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
