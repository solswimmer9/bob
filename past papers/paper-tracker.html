
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Progress Tracker</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="past-papers.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="../firebase-config.js"></script>
    <script src="../auth.js"></script>

    <!-- Past Papers Data -->
    <script src="papers.js"></script>
</head>
<body>
    <div class="tracker-container">
        <a href="chemistry-tracker.html" class="back-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to Papers
        </a>

        <div class="feedback-sheet">
            <div class="sheet-header">
                <h1>AQA A-Level Chemistry Paper Feedback Sheet</h1>
                <div class="student-info">
                    <div class="info-field">
                        <label>Student Name:</label>
                        <input type="text" id="studentName" class="editable-field" placeholder="Enter your name">
                    </div>
                    <div class="info-field">
                        <label>Date:</label>
                        <input type="date" id="testDate" class="editable-field">
                    </div>
                </div>
                <div class="paper-details" id="paperDetails">
                    <!-- Paper info will be loaded here -->
                </div>
                <div class="total-marks">
                    <label>Total Mark:</label>
                    <span id="totalScore" class="score-display">0</span>
                    <span class="max-marks">/ <span id="maxMarks">90</span></span>
                    <span class="percentage-badge" id="percentageBadge">0%</span>
                </div>
            </div>

            <div class="topics-table">
                <table class="feedback-table">
                    <thead>
                        <tr>
                            <th>Section</th>
                            <th>Topic</th>
                            <th>Marks</th>
                            <th>Areas to Work On</th>
                        </tr>
                    </thead>
                    <tbody id="topicsTableBody">
                        <!-- Topics will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="feedback-section">
                <h2>Overall Feedback:</h2>
                <textarea id="overallFeedback" class="feedback-textarea" placeholder="Enter overall feedback here..."></textarea>
            </div>

            <div class="action-plan-section">
                <h2>Action Plan:</h2>
                <textarea id="actionPlan" class="feedback-textarea" placeholder="Enter action plan here..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveProgress()">Save Progress</button>
                <button class="btn btn-secondary" onclick="exportData()">Export as PDF</button>
                <button class="btn btn-danger" onclick="clearProgress()">Clear All</button>
            </div>
        </div>
    </div>

    <script>
        // Get paper ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const paperId = urlParams.get('id');

        // Past papers data (embedded as fallback)
        const papersDataFallback = [
            {
                "id": "aqa-74051-jun24",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2024,
                "session": "June",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    { "section": "3.1.1", "name": "Atomic Structure", "maxMarks": 10 },
                    { "section": "3.1.2", "name": "Amount of Substance", "maxMarks": 8 },
                    { "section": "3.1.3", "name": "Bonding", "maxMarks": 12 },
                    { "section": "3.1.4", "name": "Energetics", "maxMarks": 10 },
                    { "section": "3.1.5", "name": "Kinetics", "maxMarks": 10 },
                    { "section": "3.1.6", "name": "Chemical Equilibria", "maxMarks": 10 },
                    { "section": "3.1.7", "name": "Oxidation & Reduction", "maxMarks": 10 },
                    { "section": "3.1.8", "name": "Thermodynamics", "maxMarks": 10 },
                    { "section": "3.1.9", "name": "Rate Equations", "maxMarks": 10 },
                    { "section": "3.1.10", "name": "Equilibrium Constant Kp", "maxMarks": 8 },
                    { "section": "3.1.11", "name": "Electrode Potentials", "maxMarks": 7 }
                ]
            },
            {
                "id": "aqa-74051-jun23",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2023,
                "session": "June",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    { "section": "3.1.1", "name": "Atomic Structure", "maxMarks": 10 },
                    { "section": "3.1.2", "name": "Amount of Substance", "maxMarks": 8 },
                    { "section": "3.1.3", "name": "Bonding", "maxMarks": 12 },
                    { "section": "3.1.4", "name": "Energetics", "maxMarks": 10 },
                    { "section": "3.1.5", "name": "Kinetics", "maxMarks": 10 },
                    { "section": "3.1.6", "name": "Chemical Equilibria", "maxMarks": 10 },
                    { "section": "3.1.7", "name": "Oxidation & Reduction", "maxMarks": 10 },
                    { "section": "3.1.8", "name": "Thermodynamics", "maxMarks": 10 },
                    { "section": "3.1.9", "name": "Rate Equations", "maxMarks": 10 },
                    { "section": "3.1.10", "name": "Equilibrium Constant Kp", "maxMarks": 8 },
                    { "section": "3.1.11", "name": "Acids & Bases", "maxMarks": 7 }
                ]
            },
            {
                "id": "aqa-74051-jun22",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2022,
                "session": "June",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    { "section": "3.1.1", "name": "Atomic Structure", "maxMarks": 10 },
                    { "section": "3.1.2", "name": "Amount of Substance", "maxMarks": 8 },
                    { "section": "3.1.3", "name": "Bonding", "maxMarks": 12 },
                    { "section": "3.1.4", "name": "Energetics", "maxMarks": 10 },
                    { "section": "3.1.5", "name": "Kinetics", "maxMarks": 10 },
                    { "section": "3.1.6", "name": "Chemical Equilibria", "maxMarks": 10 },
                    { "section": "3.1.7", "name": "Oxidation & Reduction", "maxMarks": 10 },
                    { "section": "3.1.8", "name": "Thermodynamics", "maxMarks": 10 },
                    { "section": "3.1.9", "name": "Rate Equations", "maxMarks": 10 },
                    { "section": "3.1.10", "name": "Equilibrium Constant Kp", "maxMarks": 8 },
                    { "section": "3.1.11", "name": "Acids & Bases", "maxMarks": 7 }
                ]
            },
            {
                "id": "aqa-74051-nov21",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2021,
                "session": "November",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    { "section": "3.1.1", "name": "Atomic Structure", "maxMarks": 10 },
                    { "section": "3.1.2", "name": "Amount of Substance", "maxMarks": 8 },
                    { "section": "3.1.3", "name": "Bonding", "maxMarks": 12 },
                    { "section": "3.1.4", "name": "Energetics", "maxMarks": 10 },
                    { "section": "3.1.5", "name": "Kinetics", "maxMarks": 10 },
                    { "section": "3.1.6", "name": "Chemical Equilibria", "maxMarks": 10 },
                    { "section": "3.1.7", "name": "Oxidation & Reduction", "maxMarks": 10 },
                    { "section": "3.1.8", "name": "Thermodynamics", "maxMarks": 10 },
                    { "section": "3.1.9", "name": "Rate Equations", "maxMarks": 10 },
                    { "section": "3.1.10", "name": "Equilibrium Constant Kp", "maxMarks": 8 },
                    { "section": "3.1.11", "name": "Acids & Bases", "maxMarks": 7 }
                ]
            },
            {
                "id": "aqa-74052-nov21",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/2",
                "year": 2021,
                "session": "November",
                "unit": "Paper 2",
                "title": "Organic & Inorganic Chemistry",
                "maxMarks": 90,
                "duration": 120,
                "topics": [
                    { "section": "3.1.10", "name": "Equilibrium Constant Kp", "maxMarks": 7 },
                    { "section": "3.1.11", "name": "Electrode Potentials and Electrochemical Cells", "maxMarks": 8 },
                    { "section": "3.1.12", "name": "Acids and Bases", "maxMarks": 8 },
                    { "section": "3.2.1", "name": "Optical Isomerism", "maxMarks": 7 },
                    { "section": "3.2.2", "name": "Aldehydes and Ketones", "maxMarks": 8 },
                    { "section": "3.2.3", "name": "Carboxylic Acids and Derivatives", "maxMarks": 8 },
                    { "section": "3.2.4", "name": "Aromatic Chemistry", "maxMarks": 9 },
                    { "section": "3.2.5", "name": "Amines", "maxMarks": 7 },
                    { "section": "3.2.6", "name": "Polymers", "maxMarks": 7 },
                    { "section": "3.2.7", "name": "Amino Acids, Proteins and DNA", "maxMarks": 7 },
                    { "section": "3.2.8", "name": "Organic Synthesis", "maxMarks": 7 },
                    { "section": "3.2.9", "name": "Nuclear Magnetic Resonance Spectroscopy (NMR)", "maxMarks": 7 },
                    { "section": "3.2.10", "name": "Chromatography", "maxMarks": 0 }
                ]
            },
            {
                "id": "aqa-74052-nov20",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/2",
                "year": 2020,
                "session": "November",
                "unit": "Paper 2",
                "title": "Organic & Inorganic Chemistry",
                "maxMarks": 90,
                "duration": 120,
                "topics": [
                    { "section": "3.1.10", "name": "Equilibrium Constant Kp", "maxMarks": 7 },
                    { "section": "3.1.11", "name": "Electrode Potentials and Electrochemical Cells", "maxMarks": 8 },
                    { "section": "3.1.12", "name": "Acids and Bases", "maxMarks": 8 },
                    { "section": "3.2.1", "name": "Optical Isomerism", "maxMarks": 7 },
                    { "section": "3.2.2", "name": "Aldehydes and Ketones", "maxMarks": 8 },
                    { "section": "3.2.3", "name": "Carboxylic Acids and Derivatives", "maxMarks": 8 },
                    { "section": "3.2.4", "name": "Aromatic Chemistry", "maxMarks": 9 },
                    { "section": "3.2.5", "name": "Amines", "maxMarks": 7 },
                    { "section": "3.2.6", "name": "Polymers", "maxMarks": 7 },
                    { "section": "3.2.7", "name": "Amino Acids, Proteins and DNA", "maxMarks": 7 },
                    { "section": "3.2.8", "name": "Organic Synthesis", "maxMarks": 7 },
                    { "section": "3.2.9", "name": "Nuclear Magnetic Resonance Spectroscopy (NMR)", "maxMarks": 7 },
                    { "section": "3.2.10", "name": "Chromatography", "maxMarks": 0 }
                ]
            }
        ];

        let currentPaper = null;
        let topicScores = {};
        let studentName = '';
        let testDate = '';
        let overallFeedback = '';
        let actionPlan = '';
        let currentUser = null;
        let papersData = null;

        // Load papers data from JSON file or fallback to embedded data
        async function loadPapersData() {
            try {
                // Try to fetch from JSON file first (works with local server)
                const response = await fetch('data/PastPapers.json');
                const jsonData = await response.json();

                // Transform JSON data to match the embedded structure with topics breakdown
                papersData = jsonData.map(paper => {
                    // Find matching fallback paper to get detailed topics structure
                    const fallbackPaper = papersDataFallback.find(fp => fp.id === paper.id);
                    return fallbackPaper || paper;
                });

                console.log('Loaded papers data from JSON file');
            } catch (error) {
                // Fallback to embedded data (works with file:// protocol)
                console.log('Using embedded fallback data (fetch failed, likely due to file:// protocol)');
                papersData = papersDataFallback;
            }
        }

        // Initialize - require authentication first
        async function init() {
            try {
                // Load papers data first
                await loadPapersData();

                // Check if user is signed in (optional)
                if (window.auth && window.auth.isUserSignedIn && window.auth.isUserSignedIn()) {
                    currentUser = window.auth.getCurrentUser();
                } else {
                    console.log('User not signed in - progress will not be saved');
                    currentUser = null;
                }

                if (!paperId) {
                    alert('No paper selected!');
                    window.location.href = 'chemistry-tracker.html';
                    return;
                }

                currentPaper = papersData.find(p => p.id === paperId);
                if (!currentPaper) {
                    alert('Paper not found!');
                    window.location.href = 'chemistry-tracker.html';
                    return;
                }

                await loadProgress();
                renderPaperDetails();
                renderTopicsTable();
                updateTotalScore();
                setupEventListeners();
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Load progress from Firestore (user-specific)
        async function loadProgress() {
            if (!currentUser) return;

            try {
                const docRef = db.collection('users').doc(currentUser.uid)
                    .collection('paperProgress').doc(paperId);

                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    topicScores = data.topicScores || {};
                    studentName = data.studentName || '';
                    testDate = data.testDate || '';
                    overallFeedback = data.overallFeedback || '';
                    actionPlan = data.actionPlan || '';

                    // Populate form fields
                    document.getElementById('studentName').value = studentName;
                    document.getElementById('testDate').value = testDate;
                    document.getElementById('overallFeedback').value = overallFeedback;
                    document.getElementById('actionPlan').value = actionPlan;
                } else {
                    // Initialize empty topic scores
                    topicScores = {};
                    currentPaper.topics.forEach(topic => {
                        topicScores[topic.section] = {
                            score: 0,
                            notes: ''
                        };
                    });
                }
            } catch (error) {
                console.error('Error loading progress:', error);
                alert('Failed to load your progress. Please try again.');
            }
        }

        // Save progress to Firestore (user-specific)
        async function saveProgress() {
            if (!currentUser) {
                alert('You must be signed in to save progress.');
                return;
            }

            try {
                // Get current values from form
                studentName = document.getElementById('studentName').value;
                testDate = document.getElementById('testDate').value;
                overallFeedback = document.getElementById('overallFeedback').value;
                actionPlan = document.getElementById('actionPlan').value;

                // Calculate total score
                let totalScore = 0;
                currentPaper.topics.forEach(topic => {
                    const score = topicScores[topic.section];
                    if (score && score.score) {
                        totalScore += parseFloat(score.score);
                    }
                });

                const percentage = currentPaper.maxMarks > 0 ? (totalScore / currentPaper.maxMarks * 100).toFixed(1) : 0;

                const data = {
                    paperId: paperId,
                    paperCode: currentPaper.paperCode,
                    paperTitle: currentPaper.title,
                    year: currentPaper.year,
                    session: currentPaper.session,
                    topicScores,
                    studentName,
                    testDate,
                    overallFeedback,
                    actionPlan,
                    totalScore,
                    maxMarks: currentPaper.maxMarks,
                    percentage,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Save to Firestore
                await db.collection('users').doc(currentUser.uid)
                    .collection('paperProgress').doc(paperId).set(data);

                alert('Progress saved successfully!');
            } catch (error) {
                console.error('Error saving progress:', error);
                alert('Failed to save progress. Please try again.');
            }
        }

        // Render paper details
        function renderPaperDetails() {
            document.getElementById('paperDetails').innerHTML = `
                <div style="display: flex; gap: 32px; margin-top: 16px; flex-wrap: wrap;">
                    <div class="info-field">
                        <strong>Paper:</strong> ${currentPaper.paperCode}
                    </div>
                    <div class="info-field">
                        <strong>Session:</strong> ${currentPaper.session} ${currentPaper.year}
                    </div>
                    <div class="info-field">
                        <strong>Title:</strong> ${currentPaper.title}
                    </div>
                </div>
            `;
            document.getElementById('maxMarks').textContent = currentPaper.maxMarks;
        }

        // Render topics table
        function renderTopicsTable() {
            const tbody = document.getElementById('topicsTableBody');
            tbody.innerHTML = currentPaper.topics.map(topic => {
                const score = topicScores[topic.section] || { score: 0, notes: '' };
                return `
                    <tr class="topic-row">
                        <td class="section-cell">${topic.section}</td>
                        <td class="topic-cell">${topic.name}</td>
                        <td class="marks-cell">
                            <input
                                type="number"
                                class="score-input"
                                value="${score.score || 0}"
                                max="${topic.maxMarks}"
                                min="0"
                                step="0.5"
                                data-section="${topic.section}"
                                onchange="updateTopicScore('${topic.section}', this.value)"
                            />
                            <span class="max-marks-label">/ ${topic.maxMarks}</span>
                        </td>
                        <td class="notes-cell">
                            <input
                                type="text"
                                class="notes-input"
                                value="${score.notes || ''}"
                                placeholder="Enter areas to work on..."
                                data-section="${topic.section}"
                                onchange="updateTopicNotes('${topic.section}', this.value)"
                            />
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update topic score
        function updateTopicScore(section, value) {
            if (!topicScores[section]) {
                topicScores[section] = { score: 0, notes: '' };
            }
            topicScores[section].score = parseFloat(value) || 0;
            updateTotalScore();
        }

        // Update topic notes
        function updateTopicNotes(section, value) {
            if (!topicScores[section]) {
                topicScores[section] = { score: 0, notes: '' };
            }
            topicScores[section].notes = value;
        }

        // Update total score display
        function updateTotalScore() {
            let totalScore = 0;
            currentPaper.topics.forEach(topic => {
                const score = topicScores[topic.section];
                if (score && score.score) {
                    totalScore += parseFloat(score.score);
                }
            });

            const maxMarks = currentPaper.maxMarks;
            const percentage = maxMarks > 0 ? (totalScore / maxMarks * 100) : 0;

            document.getElementById('totalScore').textContent = totalScore.toFixed(1);
            const badge = document.getElementById('percentageBadge');
            badge.textContent = percentage.toFixed(1) + '%';

            // Update badge color based on percentage
            badge.style.background = getGradeColor(percentage);
        }

        // Get grade color based on percentage
        function getGradeColor(percentage) {
            if (percentage >= 80) return 'linear-gradient(135deg, #2ed573 0%, #26de81 100%)';
            if (percentage >= 70) return 'linear-gradient(135deg, #26de81 0%, #2ed573 100%)';
            if (percentage >= 60) return 'linear-gradient(135deg, #ffa502 0%, #ff7f50 100%)';
            if (percentage >= 50) return 'linear-gradient(135deg, #ff7f50 0%, #ff6348 100%)';
            return 'linear-gradient(135deg, #ff6348 0%, #ff4757 100%)';
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auto-save on input change
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.id === 'studentName' || input.id === 'testDate') {
                    input.addEventListener('change', () => {
                        studentName = document.getElementById('studentName').value;
                        testDate = document.getElementById('testDate').value;
                    });
                }
            });
        }

        // Export data as PDF (simplified version - exports as text)
        function exportData() {
            const data = {
                paper: currentPaper,
                studentName,
                testDate,
                topicScores,
                overallFeedback: document.getElementById('overallFeedback').value,
                actionPlan: document.getElementById('actionPlan').value,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${paperId}-feedback-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Clear progress
        async function clearProgress() {
            if (!currentUser) {
                alert('You must be signed in to clear progress.');
                return;
            }

            if (confirm('Are you sure you want to clear all progress for this paper? This cannot be undone!')) {
                try {
                    topicScores = {};
                    currentPaper.topics.forEach(topic => {
                        topicScores[topic.section] = { score: 0, notes: '' };
                    });
                    document.getElementById('studentName').value = '';
                    document.getElementById('testDate').value = '';
                    document.getElementById('overallFeedback').value = '';
                    document.getElementById('actionPlan').value = '';

                    // Delete from Firestore
                    await db.collection('users').doc(currentUser.uid)
                        .collection('paperProgress').doc(paperId).delete();

                    renderTopicsTable();
                    updateTotalScore();
                    alert('Progress cleared successfully!');
                } catch (error) {
                    console.error('Error clearing progress:', error);
                    alert('Failed to clear progress. Please try again.');
                }
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
