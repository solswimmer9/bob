<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Progress Tracker</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="past-papers.css">
</head>
<body>
    <div class="tracker-container">
        <a href="chemistry-tracker.html" class="back-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M12 4L6 10L12 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to Papers
        </a>

        <div class="paper-header" id="paperHeader">
            <!-- Paper info will be loaded here -->
        </div>

        <div class="stats-overview" id="statsOverview">
            <!-- Stats will be loaded here -->
        </div>

        <div class="questions-section">
            <div class="section-header">
                <h2 class="section-title">Question Breakdown</h2>
                <button class="add-question-btn" onclick="addQuestion()">+ Add Question</button>
            </div>

            <div id="questionsContainer">
                <!-- Questions will be loaded here -->
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveProgress()">üíæ Save Progress</button>
            <button class="btn btn-secondary" onclick="exportData()">üì• Export Data</button>
            <button class="btn btn-danger" onclick="clearProgress()">üóëÔ∏è Clear All</button>
        </div>
    </div>

    <script>
        // Get paper ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const paperId = urlParams.get('id');

        // Past papers data (embedded)
        const papersData = [
            {
                "id": "aqa-74051-jun24",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2024,
                "session": "June",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    "Atomic Structure",
                    "Amount of Substance",
                    "Bonding",
                    "Energetics",
                    "Kinetics",
                    "Chemical Equilibria",
                    "Oxidation & Reduction",
                    "Thermodynamics",
                    "Rate Equations",
                    "Equilibrium Constant",
                    "Acids & Bases"
                ]
            },
            {
                "id": "aqa-74051-jun23",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2023,
                "session": "June",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    "Atomic Structure",
                    "Amount of Substance",
                    "Bonding",
                    "Energetics",
                    "Kinetics",
                    "Chemical Equilibria",
                    "Oxidation & Reduction",
                    "Thermodynamics",
                    "Rate Equations",
                    "Equilibrium Constant",
                    "Acids & Bases"
                ]
            },
            {
                "id": "aqa-74051-jun22",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2022,
                "session": "June",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    "Atomic Structure",
                    "Amount of Substance",
                    "Bonding",
                    "Energetics",
                    "Kinetics",
                    "Chemical Equilibria",
                    "Oxidation & Reduction",
                    "Thermodynamics",
                    "Rate Equations",
                    "Equilibrium Constant",
                    "Acids & Bases"
                ]
            },
            {
                "id": "aqa-74051-nov21",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/1",
                "year": 2021,
                "session": "November",
                "unit": "Paper 1",
                "title": "Physical Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    "Atomic Structure",
                    "Amount of Substance",
                    "Bonding",
                    "Energetics",
                    "Kinetics",
                    "Chemical Equilibria",
                    "Oxidation & Reduction",
                    "Thermodynamics",
                    "Rate Equations",
                    "Equilibrium Constant",
                    "Acids & Bases"
                ]
            },
            {
                "id": "aqa-74052-nov21",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/2",
                "year": 2021,
                "session": "November",
                "unit": "Paper 2",
                "title": "Organic & Inorganic Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    "Periodicity",
                    "Group 2",
                    "Group 7",
                    "Transition Metals",
                    "Organic Analysis",
                    "Alkanes",
                    "Alkenes",
                    "Alcohols",
                    "Organic Synthesis",
                    "Analytical Techniques"
                ]
            },
            {
                "id": "aqa-74052-nov20",
                "examBoard": "AQA",
                "qualification": "A-Level",
                "paperCode": "7405/2",
                "year": 2020,
                "session": "November",
                "unit": "Paper 2",
                "title": "Organic & Inorganic Chemistry",
                "maxMarks": 105,
                "duration": 120,
                "topics": [
                    "Periodicity",
                    "Group 2",
                    "Group 7",
                    "Transition Metals",
                    "Organic Analysis",
                    "Alkanes",
                    "Alkenes",
                    "Alcohols",
                    "Organic Synthesis",
                    "Analytical Techniques"
                ]
            }
        ];

        let currentPaper = null;
        let questions = [];

        // Grade boundaries for single paper (out of 105 marks)
        const PAPER_GRADE_BOUNDARIES = {
            'A*': 84,  // 80% of 105
            'A': 66,   // 63% of 105
            'B': 54,   // 51% of 105
            'C': 42,   // 40% of 105
            'D': 30,   // 29% of 105
            'E': 18    // 17% of 105
        };

        // Initialize
        function init() {
            if (!paperId) {
                alert('No paper selected!');
                window.location.href = 'chemistry-tracker.html';
                return;
            }

            currentPaper = papersData.find(p => p.id === paperId);
            if (!currentPaper) {
                alert('Paper not found!');
                window.location.href = 'chemistry-tracker.html';
                return;
            }

            loadProgress();
            renderPaperHeader();
            renderStats();
            renderQuestions();
        }

        // Load progress from localStorage
        function loadProgress() {
            const saved = localStorage.getItem(`paper-progress-${paperId}`);
            if (saved) {
                questions = JSON.parse(saved);
            } else {
                // Initialize with empty questions
                questions = [];
            }
        }

        // Save progress to localStorage
        function saveProgress() {
            localStorage.setItem(`paper-progress-${paperId}`, JSON.stringify(questions));

            // Also save to global analytics
            updateGlobalAnalytics();

            alert('Progress saved successfully!');
        }

        // Update global analytics
        function updateGlobalAnalytics() {
            const analytics = JSON.parse(localStorage.getItem('chemistry-analytics') || '{}');

            const totalMarks = questions.reduce((sum, q) => sum + (parseFloat(q.maxMarks) || 0), 0);
            const earnedMarks = questions.reduce((sum, q) => sum + (parseFloat(q.earnedMarks) || 0), 0);

            analytics[paperId] = {
                paper: currentPaper,
                questions: questions,
                totalMarks: totalMarks,
                earnedMarks: earnedMarks,
                percentage: totalMarks > 0 ? (earnedMarks / totalMarks * 100).toFixed(1) : 0,
                lastUpdated: new Date().toISOString()
            };

            localStorage.setItem('chemistry-analytics', JSON.stringify(analytics));
        }

        // Render paper header
        function renderPaperHeader() {
            document.getElementById('paperHeader').innerHTML = `
                <h1>${currentPaper.title}</h1>
                <div class="paper-info">
                    <div class="info-item">
                        <span class="info-label">Paper Code</span>
                        <span class="info-value">${currentPaper.paperCode}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Session</span>
                        <span class="info-value">${currentPaper.session} ${currentPaper.year}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Max Marks</span>
                        <span class="info-value">${currentPaper.maxMarks}</span>
                    </div>
                </div>
            `;
        }

        // Calculate stats
        function calculateStats() {
            const totalMarks = questions.reduce((sum, q) => sum + (parseFloat(q.maxMarks) || 0), 0);
            const earnedMarks = questions.reduce((sum, q) => sum + (parseFloat(q.earnedMarks) || 0), 0);
            const percentage = totalMarks > 0 ? (earnedMarks / totalMarks * 100) : 0;

            let grade = 'N/A';
            let gradeClass = '';

            if (earnedMarks >= PAPER_GRADE_BOUNDARIES['A*']) {
                grade = 'A*';
                gradeClass = 'grade-a';
            } else if (earnedMarks >= PAPER_GRADE_BOUNDARIES['A']) {
                grade = 'A';
                gradeClass = 'grade-a';
            } else if (earnedMarks >= PAPER_GRADE_BOUNDARIES['B']) {
                grade = 'B';
                gradeClass = 'grade-b';
            } else if (earnedMarks >= PAPER_GRADE_BOUNDARIES['C']) {
                grade = 'C';
                gradeClass = 'grade-c';
            } else if (earnedMarks >= PAPER_GRADE_BOUNDARIES['D']) {
                grade = 'D';
                gradeClass = 'grade-d';
            } else if (earnedMarks >= PAPER_GRADE_BOUNDARIES['E']) {
                grade = 'E';
                gradeClass = 'grade-e';
            }

            return { totalMarks, earnedMarks, percentage, grade, gradeClass };
        }

        // Render stats
        function renderStats() {
            const stats = calculateStats();

            document.getElementById('statsOverview').innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${questions.length}</div>
                    <div class="stat-label">Questions Tracked</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${stats.earnedMarks.toFixed(1)} / ${stats.totalMarks}</div>
                    <div class="stat-label">Total Marks</div>
                </div>
                <div class="stat-box highlight">
                    <div class="stat-value">${stats.percentage.toFixed(1)}%</div>
                    <div class="stat-label">Percentage</div>
                </div>
                <div class="stat-box ${stats.gradeClass}">
                    <div class="stat-value">${stats.grade}</div>
                    <div class="stat-label">Predicted Grade</div>
                </div>
            `;
        }

        // Add question
        function addQuestion() {
            const questionNum = questions.length + 1;
            questions.push({
                number: questionNum,
                topic: currentPaper.topics[0] || 'General',
                maxMarks: 0,
                earnedMarks: 0
            });
            renderQuestions();
            renderStats();
        }

        // Delete question
        function deleteQuestion(index) {
            if (confirm('Are you sure you want to delete this question?')) {
                questions.splice(index, 1);
                // Renumber questions
                questions.forEach((q, i) => q.number = i + 1);
                renderQuestions();
                renderStats();
            }
        }

        // Update question
        function updateQuestion(index, field, value) {
            questions[index][field] = value;
            renderStats();
        }

        // Render questions
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');

            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No questions added yet.</p>
                        <p>Click "Add Question" to start tracking your progress!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="questions-grid">
                    ${questions.map((q, index) => {
                        const percentage = q.maxMarks > 0 ? (q.earnedMarks / q.maxMarks * 100) : 0;
                        let percentClass = 'percentage-display';
                        if (percentage >= 70) percentClass += ' good';
                        else if (percentage >= 40) percentClass += ' okay';
                        else if (percentage > 0) percentClass += ' poor';

                        return `
                            <div class="question-row">
                                <div class="question-number">Q${q.number}</div>
                                <select class="topic-select" onchange="updateQuestion(${index}, 'topic', this.value)">
                                    ${currentPaper.topics.map(topic =>
                                        `<option value="${topic}" ${q.topic === topic ? 'selected' : ''}>${topic}</option>`
                                    ).join('')}
                                </select>
                                <div class="marks-group">
                                    <div class="marks-label">Max Marks</div>
                                    <input type="number" class="marks-input" value="${q.maxMarks}"
                                        onchange="updateQuestion(${index}, 'maxMarks', parseFloat(this.value) || 0)"
                                        min="0" step="0.5" placeholder="0">
                                </div>
                                <div class="marks-group">
                                    <div class="marks-label">Your Marks</div>
                                    <input type="number" class="marks-input" value="${q.earnedMarks}"
                                        onchange="updateQuestion(${index}, 'earnedMarks', parseFloat(this.value) || 0)"
                                        min="0" step="0.5" placeholder="0">
                                </div>
                                <div class="${percentClass}">
                                    ${percentage > 0 ? percentage.toFixed(0) + '%' : '-'}
                                </div>
                                <button class="delete-btn" onclick="deleteQuestion(${index})" title="Delete question">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Export data as JSON
        function exportData() {
            const data = {
                paper: currentPaper,
                questions: questions,
                stats: calculateStats(),
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${paperId}-progress.json`;
            a.click();
        }

        // Clear progress
        function clearProgress() {
            if (confirm('Are you sure you want to clear all progress for this paper? This cannot be undone!')) {
                questions = [];
                localStorage.removeItem(`paper-progress-${paperId}`);
                renderQuestions();
                renderStats();
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
